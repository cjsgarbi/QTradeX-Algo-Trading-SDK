{
 "source": "\"\"\"\n\u2554\u2550\u2557\u2554\u2566\u2557\u2566\u2550\u2557\u2554\u2550\u2557\u2554\u2566\u2557\u2554\u2550\u2557\u2550\u2557 \u2566\n\u2551\u2550\u256c\u2557\u2551 \u2560\u2566\u255d\u2560\u2550\u2563 \u2551\u2551\u2551\u2563 \u2554\u2569\u2566\u255d\n\u255a\u2550\u255d\u255a\u2569 \u2569\u255a\u2550\u2569 \u2569\u2550\u2569\u255d\u255a\u2550\u255d\u2569 \u255a\u2550\n\nextinction_event.py\n\nExtinction Event\n\nIndicators;\n\n    - ma1, ma2, ma3: Exponential Moving Averages (EMAs) with different periods\n    - support: A support level based on a weighted combination of `ma1` and `ma2`\n    - selloff: A selloff threshold based on a weighted combination of `ma1` and `ma2`\n    - despair: A despair level based on a weighted combination of `ma1` and `ma2`\n    - resistance: A resistance level based on a weighted combination of `ma1` and `ma2`\n    - trend: The current market trend, which can be 'bull', 'bear', or None\n    - buying: A calculated buying price based on the current trend and indicators\n    - selling: A calculated selling price based on the current trend and indicators\n    - override: Overrides the default behavior with 'buy' or 'sell' signals when a trend shift occurs\n\n\nStrategy:\n\n    Trending:\n\n    - when the low price is first above the long average a qx.Buy is initiated indicating end of the Bear market\n    - when the high price is first below the long average a qx.Sell is initiated indicating end of the Bull market\n\n    Channeled:\n\n    - During Bull Market a trading channel is defined by support and selloff\n    - During Bear Market a trading channel is defined by despair and resistance\n\"\"\"\n\nimport time\n\nimport numpy as np\nimport qtradex as qx\n\n\n\nclass ExtinctionEvent(qx.BaseBot):\n    def __init__(self):\n        # Configura o timeframe preferido desta estrategia para os agentes lerem\n        self.timeframe = TIMEFRAME\n        \n        self.tune = {\n            \"ma1_period\": 5.8,\n            \"ma2_period\": 15.0,\n            \"ma3_period\": 30.0,\n            \"selloff ma1\": 1.1,\n            \"selloff ma2\": 1.1,\n            \"selloff ratio\": 0.5,\n            \"support ma1\": 1.0,\n            \"support ma2\": 1.0,\n            \"support ratio\": 0.5,\n            \"resistance ma1\": 1.0,\n            \"resistance ma2\": 1.0,\n            \"resistance ratio\": 0.5,\n            \"despair ma1\": 0.9,\n            \"despair ma2\": 0.9,\n            \"despair ratio\": 0.5,\n        }\n\n        self.clamps = {\n            \"ma1_period\": [5, 5.8, 100, 0.5],\n            \"ma2_period\": [5, 15.0, 100, 0.5],\n            \"ma3_period\": [5, 30.0, 100, 0.5],\n            \"selloff ma1\": [0.9, 1.1, 1.2, 0.5],\n            \"selloff ma2\": [0.9, 1.1, 1.2, 0.5],\n            \"selloff ratio\": [0.25, 0.5, 0.75, 0.5],\n            \"support ma1\": [0.9, 1.0, 1.2, 0.5],\n            \"support ma2\": [0.9, 1.0, 1.2, 0.5],\n            \"support ratio\": [0.25, 0.5, 0.75, 0.5],\n            \"resistance ma1\": [0.9, 1.0, 1.2, 0.5],\n            \"resistance ma2\": [0.9, 1.0, 1.2, 0.5],\n            \"resistance ratio\": [0.25, 0.5, 0.75, 0.5],\n            \"despair ma1\": [0.9, 0.9, 1.2, 0.5],\n            \"despair ma2\": [0.9, 0.9, 1.2, 0.5],\n            \"despair ratio\": [0.25, 0.5, 0.75, 0.5],\n        }\n\n    def indicators(self, data):\n        metrics = {\n            tag.rsplit(\"_\", 1)[0]: qx.ti.ema(data[\"close\"], self.tune[tag])\n            for tag in [\"ma1_period\", \"ma2_period\", \"ma3_period\"]\n        }\n        metrics[\"ma_exec\"] = qx.ti.ema(data[\"close\"], 2)\n        metrics[\"support\"] = []\n        metrics[\"selloff\"] = []\n        metrics[\"despair\"] = []\n        metrics[\"resistance\"] = []\n        metrics[\"trend\"] = []\n        metrics[\"buying\"] = []\n        metrics[\"selling\"] = []\n        metrics[\"override\"] = []\n\n        trend = None\n\n        for ma1, ma2, ma3, low, high in zip(\n            metrics[\"ma1\"], metrics[\"ma2\"], metrics[\"ma3\"], data[\"low\"], data[\"high\"]\n        ):\n            support = ma1 * self.tune[\"support ma1\"] * self.tune[\n                \"support ratio\"\n            ] + ma2 * self.tune[\"support ma2\"] * (1 - self.tune[\"support ratio\"])\n            selloff = ma1 * self.tune[\"selloff ma1\"] * self.tune[\n                \"selloff ratio\"\n            ] + ma2 * self.tune[\"selloff ma2\"] * (1 - self.tune[\"selloff ratio\"])\n            despair = ma1 * self.tune[\"despair ma1\"] * self.tune[\n                \"despair ratio\"\n            ] + ma2 * self.tune[\"despair ma2\"] * (1 - self.tune[\"despair ratio\"])\n            resistance = ma1 * self.tune[\"resistance ma1\"] * self.tune[\n                \"resistance ratio\"\n            ] + ma2 * self.tune[\"resistance ma2\"] * (1 - self.tune[\"resistance ratio\"])\n\n            # SECURITY: prevent flash trading risk\n            support, selloff = sorted([support, selloff])\n            despair, resistance = sorted([despair, resistance])\n\n            metrics[\"selloff\"].append(selloff)\n            metrics[\"support\"].append(support)\n            metrics[\"resistance\"].append(resistance)\n            metrics[\"despair\"].append(despair)\n\n            if low > ma3 and trend != \"bull\":\n                trend = \"bull\"\n                metrics[\"override\"].append(\"buy\")\n            elif high < ma3 and trend != \"bear\":\n                trend = \"bear\"\n                metrics[\"override\"].append(\"sell\")\n            else:\n                metrics[\"override\"].append(None)\n\n            if trend is None:\n                metrics[\"buying\"].append(metrics[\"ma3\"][-1] / 2)\n                metrics[\"selling\"].append(metrics[\"ma3\"][-1] * 2)\n            elif trend == \"bull\":\n                metrics[\"buying\"].append(metrics[\"support\"][-1])\n                metrics[\"selling\"].append(metrics[\"selloff\"][-1])\n            elif trend == \"bear\":\n                metrics[\"buying\"].append(metrics[\"despair\"][-1])\n                metrics[\"selling\"].append(metrics[\"resistance\"][-1])\n            else:\n                raise RuntimeError\n\n            metrics[\"trend\"].append(trend)\n\n        return metrics\n\n    def plot(self, data, states, indicators, block):\n        axes = qx.plot(\n            self.info,\n            data,\n            states,\n            indicators,\n            False,\n            (\n                # key, name, color, index, title\n                (\"ma3\", \"LONG\", \"white\", 0, \"Extinction Event\"),\n            ),\n        )\n\n        axes[0].fill_between(\n            states[\"dates\"],\n            indicators[\"selloff\"],\n            indicators[\"support\"],\n            color=\"lime\",\n            alpha=0.3,\n            where=[i == \"bull\" for i in indicators[\"trend\"]],\n            label=\"Support/Selloff\",\n            step=\"post\",\n        )\n\n        axes[0].fill_between(\n            states[\"dates\"],\n            indicators[\"resistance\"],\n            indicators[\"despair\"],\n            color=\"tomato\",\n            alpha=0.4,\n            where=qx.expand_bools([i == \"bear\" for i in indicators[\"trend\"]]),\n            label=\"Resistance/Despair\",\n            step=\"post\",\n        )\n\n        axes[0].legend()\n        qx.plotmotion(block)\n\n    def strategy(self, tick_info, indicators):\n        if indicators[\"override\"] == \"buy\" and isinstance(\n            tick_info[\"last_trade\"], (qx.Sell, qx.Thresholds)\n        ):\n            ret = qx.Buy()\n        elif indicators[\"override\"] == \"sell\" and isinstance(\n            tick_info[\"last_trade\"], (qx.Buy, qx.Thresholds)\n        ):\n            ret = qx.Sell()\n        else:\n            ret = qx.Thresholds(\n                buying=indicators[\"buying\"], selling=indicators[\"selling\"]\n            )\n        return ret\n\n    def execution(self, signal, indicators, wallet):\n        \"\"\"Executa ordens no pre\u00e7o de mercado atual.\"\"\"\n        if isinstance(signal, qx.Buy):\n            return qx.Buy()\n        elif isinstance(signal, qx.Sell):\n            return qx.Sell()\n        else:\n            return signal\n\n    def fitness(self, states, raw_states, asset, currency):\n        return [\n            \"roi_assets\",\n            \"roi_currency\",\n            \"roi\",\n            \"cagr\",\n            \"sortino\",\n            \"maximum_drawdown\",\n            \"trade_win_rate\",\n        ], {}\n\n\n# --- CONFIGURACAO GLOBAL DE TEMPO GRAFICO ---\n# Timeframe usado por todos os agentes (Backtest, Otimizadores, Paper, Live)\n# 60=1m, 300=5m, 900=15m, 3600=1h, 14400=4h, 86400=1d\nTIMEFRAME = 900 \nFEE       = 0.1 \n\ndef main():\n    import time\n    asset, currency = \"SOL\", \"USDT\"\n    wallet = qx.PaperWallet({asset: 0, currency: 10000}, fee=FEE)\n    \n    data = qx.Data(\n        exchange=\"binance\",\n        asset=asset,\n        currency=currency,\n        # pool=\"1.19.160\",\n        begin=\"2025-06-01\",\n        #end=\"2026-01-14\",  # Data fixa (opcional)\n        end=int(time.time()),\n        candle_size=TIMEFRAME, # Configura para Backtest e Otimizadores\n    )\n    # python strategies/extinction_event.py\n    bot = ExtinctionEvent()\n    \n    qx.dispatch(bot, data, wallet)\n\n\nif __name__ == \"__main__\":\n    main()",
 "BEST ROI TUNE_Fri Jan 23 15:28:22 2026_SOL_USDT_900_Fri Jan 23 15:28:22 2026": {
  "identifier": "BEST ROI TUNE_Fri Jan 23 15:28:22 2026_SOL_USDT_900_Fri Jan 23 15:28:22 2026",
  "asset": "SOL",
  "currency": "USDT",
  "timeframe": 900,
  "tune": {
   "ma1_period": 22,
   "ma2_period": 5,
   "ma3_period": 41.42273180319652,
   "selloff ma1": 1.0043035868616168,
   "selloff ma2": 0.9679454206021341,
   "selloff ratio": 0.30719599398760056,
   "support ma1": 0.9907942294946489,
   "support ma2": 1.2,
   "support ratio": 0.37539269857334284,
   "resistance ma1": 0.9880610603905808,
   "resistance ma2": 0.9791543725275479,
   "resistance ratio": 0.7456228265345062,
   "despair ma1": 0.9,
   "despair ma2": 0.9503625758497608,
   "despair ratio": 0.75
  },
  "results": {
   "roi": 2.537098603272237,
   "roi_assets": 3.037582484315378,
   "roi_currency": 2.537098603272237,
   "cagr": 3.8306557219794737,
   "maximum_drawdown": 0.13186168172765902,
   "trade_win_rate": 0.4827586206896552
  }
 }
}