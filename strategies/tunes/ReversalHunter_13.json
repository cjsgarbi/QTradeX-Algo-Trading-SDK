{
 "source": "\"\"\"\nReversalHunter - High-Precision Trend Reversal Detection Strategy\n==================================================================\n\nEsta estrat\u00e9gia usa a conflu\u00eancia de 3 indicadores avan\u00e7ados para detectar\nrevers\u00f5es de tend\u00eancia com alta precis\u00e3o:\n\n1. STOCHASTIC RSI - Detecta zonas extremas de sobrecompra/sobrevenda\n2. ADX + DI - Mede for\u00e7a e dire\u00e7\u00e3o da tend\u00eancia\n3. MFI (Money Flow Index) - Confirma fluxo de dinheiro real com volume\n\nL\u00d3GICA DE CONFLU\u00caNCIA:\n- COMPRA: StochRSI sobrevenda + +DI > -DI + MFI subindo de sobrevenda\n- VENDA: StochRSI sobrecompra + -DI > +DI + MFI caindo de sobrecompra\n\nBaseado em pesquisas de indicadores para detec\u00e7\u00e3o de revers\u00f5es em crypto.\n\"\"\"\n\nimport qtradex as qx\nimport numpy as np\nfrom datetime import datetime\nimport time\n\n\nclass ReversalHunter(qx.BaseBot):\n    \"\"\"\n    Estrat\u00e9gia de alta precis\u00e3o para detec\u00e7\u00e3o de revers\u00f5es de tend\u00eancia.\n    Combina Stochastic RSI, ADX/DI e MFI em conflu\u00eancia.\n    \"\"\"\n    \n    def __init__(self):\n        \"\"\"\n        Inicializa\u00e7\u00e3o com par\u00e2metros otimiz\u00e1veis para cada indicador.\n        \"\"\"\n        self.timeframe = TIMEFRAME\n        self.fee = FEE\n        self.warmup = 120  # Candles para aquecer indicadores (aumentado para evitar NaN)\n        \n        # Estado interno para tracking de diverg\u00eancias\n        self.prev_stochrsi = None\n        self.prev_mfi = None\n        self.prev_close = None\n        \n        # ===================================================================\n        # TUNE: Par\u00e2metros centralizados para o otimizador (Filosofia Scalp)\n        # ===================================================================\n        self.tune = {\n            # Stochastic RSI\n            \"stochrsi_period\": 14,         # (7+21)/2\n            \"stochrsi_k_period\": 14,       # (7+21)/2\n            \"stochrsi_k_slow\": 4,          # (2+6)/2\n            \"stochrsi_d_period\": 4,        # (2+6)/2\n            \n            # ADX / DI\n            \"adx_period\": 17,              # (7+28)/2 approx\n            \n            # MFI\n            \"mfi_period\": 17,              # (7+28)/2 approx\n            \n            # Limiares de decis\u00e3o\n            \"stochrsi_oversold\": 20,       # (10+30)/2\n            \"stochrsi_overbought\": 80,     # (70+90)/2\n            \"mfi_oversold\": 30,            # (20+40)/2\n            \"mfi_overbought\": 70,          # (60+80)/2\n            \"adx_threshold\": 20,           # (10+30)/2\n            \"di_diff_min\": 8,              # (2+14)/2\n            \n            # Confirma\u00e7\u00e3o de tend\u00eancia\n            \"require_adx_rising\": 1,\n        }\n        \n        # ===================================================================\n        # CLAMPS: Ranges AMPLOS para volatilidade Cripto\n        # ===================================================================\n        self.clamps = {\n            # Stochastic RSI (Steps moderados: 2)\n            \"stochrsi_period\": [7, 14, 21, 2],\n            \"stochrsi_k_period\": [7, 14, 21, 2],\n            \"stochrsi_k_slow\": [2, 4, 6, 1],\n            \"stochrsi_d_period\": [2, 4, 6, 1],\n            \n            # ADX / DI (Expandido para cobrir micro e macro)\n            \"adx_period\": [7, 17, 28, 3],\n            \n            # MFI (Similar ao ADX)\n            \"mfi_period\": [7, 17, 28, 3],\n            \n            # Limiares (Preciso e granular: step 2)\n            \"stochrsi_oversold\": [10, 20, 30, 2],\n            \"stochrsi_overbought\": [70, 80, 90, 2],\n            \"mfi_oversold\": [20, 30, 40, 2],\n            \"mfi_overbought\": [60, 70, 80, 2],\n            \"adx_threshold\": [10, 20, 30, 2],\n            \"di_diff_min\": [2, 8, 14, 2],\n            \n            \"require_adx_rising\": [0, 1, 1, 1],\n        }\n\n\n    def indicators(self, data):\n        \"\"\"\n        Calcula os 3 indicadores principais para conflu\u00eancia.\n        \"\"\"\n        high = data[\"high\"]\n        low = data[\"low\"]\n        close = data[\"close\"]\n        volume = data[\"volume\"]\n        \n        # --- STOCHASTIC RSI ---\n        # Primeiro calculamos RSI, depois aplicamos Stochastic no RSI\n        stochrsi = qx.ti.stochrsi(close, self.tune[\"stochrsi_period\"])\n        \n        # Stochastic tradicional para K e D\n        stoch_k, stoch_d = qx.ti.stoch(\n            high, low, close,\n            self.tune[\"stochrsi_k_period\"],\n            self.tune[\"stochrsi_k_slow\"],\n            self.tune[\"stochrsi_d_period\"]\n        )\n        \n        # --- ADX + DI ---\n        adx = qx.ti.adx(high, low, close, self.tune[\"adx_period\"])\n        plus_di, minus_di = qx.ti.di(high, low, close, self.tune[\"adx_period\"])\n        \n        # --- MFI (Money Flow Index) ---\n        mfi = qx.ti.mfi(high, low, close, volume, self.tune[\"mfi_period\"])\n        \n        # --- RSI para refer\u00eancia adicional ---\n        rsi = qx.ti.rsi(close, 14)\n        \n        return {\n            \"stochrsi\": stochrsi,\n            \"stoch_k\": stoch_k,\n            \"stoch_d\": stoch_d,\n            \"adx\": adx,\n            \"plus_di\": plus_di,\n            \"minus_di\": minus_di,\n            \"mfi\": mfi,\n            \"rsi\": rsi,\n        }\n\n    def strategy(self, tick_info, indicators):\n        \"\"\"\n        L\u00f3gica de decis\u00e3o baseada em conflu\u00eancia dos 3 indicadores.\n        \n        COMPRA quando:\n        - Stochastic RSI em zona de sobrevenda (<20) ou cruzando para cima\n        - +DI > -DI (bulls dominando)\n        - MFI saindo de sobrevenda ou subindo\n        - ADX mostrando for\u00e7a (>20)\n        \n        VENDA quando:\n        - Stochastic RSI em zona de sobrecompra (>80) ou cruzando para baixo\n        - -DI > +DI (bears dominando)\n        - MFI saindo de sobrecompra ou caindo\n        \"\"\"\n        # Obter valores dos indicadores\n        stochrsi = indicators[\"stochrsi\"]\n        stoch_k = indicators[\"stoch_k\"]\n        stoch_d = indicators[\"stoch_d\"]\n        adx = indicators[\"adx\"]\n        plus_di = indicators[\"plus_di\"]\n        minus_di = indicators[\"minus_di\"]\n        mfi = indicators[\"mfi\"]\n        \n        # Verificar valores v\u00e1lidos (evitar NaN no in\u00edcio)\n        if np.isnan(stochrsi) or np.isnan(adx) or np.isnan(mfi):\n            return None\n        \n        # Par\u00e2metros\n        stochrsi_oversold = self.tune[\"stochrsi_oversold\"]\n        stochrsi_overbought = self.tune[\"stochrsi_overbought\"]\n        mfi_oversold = self.tune[\"mfi_oversold\"]\n        mfi_overbought = self.tune[\"mfi_overbought\"]\n        adx_threshold = self.tune[\"adx_threshold\"]\n        di_diff_min = self.tune[\"di_diff_min\"]\n        \n        # ===================================================================\n        # CONDI\u00c7\u00d5ES DE COMPRA (Revers\u00e3o de Alta)\n        # ===================================================================\n        \n        # 1. Stochastic RSI em sobrevenda ou saindo de sobrevenda\n        stochrsi_buy = stochrsi < stochrsi_oversold or (\n            self.prev_stochrsi is not None and \n            self.prev_stochrsi < stochrsi_oversold and \n            stochrsi >= stochrsi_oversold\n        )\n        \n        # 2. +DI dominando (bulls stronger)\n        di_buy = (plus_di - minus_di) >= di_diff_min\n        \n        # 3. MFI favor\u00e1vel (n\u00e3o sobrecomprado, preferencialmente subindo)\n        mfi_buy = mfi < mfi_overbought and (\n            mfi < mfi_oversold + 20 or  # Ainda em zona baixa\n            (self.prev_mfi is not None and mfi > self.prev_mfi)  # Subindo\n        )\n        \n        # 4. ADX mostrando for\u00e7a\n        adx_buy = adx >= adx_threshold\n        \n        # ===================================================================\n        # CONDI\u00c7\u00d5ES DE VENDA (Revers\u00e3o de Baixa)\n        # ===================================================================\n        \n        # 1. Stochastic RSI em sobrecompra ou saindo de sobrecompra\n        stochrsi_sell = stochrsi > stochrsi_overbought or (\n            self.prev_stochrsi is not None and \n            self.prev_stochrsi > stochrsi_overbought and \n            stochrsi <= stochrsi_overbought\n        )\n        \n        # 2. -DI dominando (bears stronger)\n        di_sell = (minus_di - plus_di) >= di_diff_min\n        \n        # 3. MFI favor\u00e1vel (n\u00e3o sobrevendido, preferencialmente caindo)\n        mfi_sell = mfi > mfi_oversold and (\n            mfi > mfi_overbought - 20 or  # Ainda em zona alta\n            (self.prev_mfi is not None and mfi < self.prev_mfi)  # Caindo\n        )\n        \n        # 4. ADX mostrando for\u00e7a\n        adx_sell = adx >= adx_threshold\n        \n        # ===================================================================\n        # DECIS\u00c3O FINAL - CONFLU\u00caNCIA\n        # ===================================================================\n        \n        # Atualizar estado anterior\n        self.prev_stochrsi = stochrsi\n        self.prev_mfi = mfi\n        self.prev_close = tick_info[\"close\"]\n        \n        # Contar sinais de compra (m\u00ednimo 3 de 4 para alta confian\u00e7a)\n        buy_signals = sum([stochrsi_buy, di_buy, mfi_buy, adx_buy])\n        sell_signals = sum([stochrsi_sell, di_sell, mfi_sell, adx_sell])\n        \n        # --- SINAL DE COMPRA ---\n        if buy_signals >= 3 and not stochrsi_sell:\n            return qx.Buy()\n        \n        # --- SINAL DE VENDA ---\n        elif sell_signals >= 3 and not stochrsi_buy:\n            return qx.Sell()\n        \n        # --- HOLD ---\n        return None\n\n    def execution(self, signal, indicators, wallet):\n        \"\"\"\n        Executa ordens a mercado.\n        \"\"\"\n        if isinstance(signal, qx.Buy):\n            return qx.Buy()\n        elif isinstance(signal, qx.Sell):\n            return qx.Sell()\n        return signal\n    \n    def reset(self):\n        \"\"\"\n        Reset estado interno entre otimiza\u00e7\u00f5es.\n        \"\"\"\n        self.prev_stochrsi = None\n        self.prev_mfi = None\n        self.prev_close = None\n\n    def plot(self, *args):\n        \"\"\"\n        Visualiza\u00e7\u00e3o dos indicadores.\n        \n        Painel 0: Pre\u00e7o + nada adicional\n        Painel 1: ADX + DI (For\u00e7a e Dire\u00e7\u00e3o)\n        Painel 2: Stochastic RSI\n        Painel 3: MFI\n        \"\"\"\n        qx.plot(\n            self.info,\n            *args,\n            (\n                # Painel 1: ADX + DI\n                (\"adx\",      \"ADX\",      \"yellow\", 1, \"ADX/DI\"),\n                (\"plus_di\",  \"+DI\",      \"green\",  1, \"ADX/DI\"),\n                (\"minus_di\", \"-DI\",      \"red\",    1, \"ADX/DI\"),\n                \n                # Painel 2: Stochastic RSI\n                (\"stochrsi\", \"StochRSI\", \"cyan\",   2, \"StochRSI\"),\n                (\"stoch_k\",  \"K\",        \"white\",  2, \"StochRSI\"),\n                (\"stoch_d\",  \"D\",        \"orange\", 2, \"StochRSI\"),\n                \n                # Painel 3: MFI\n                (\"mfi\",      \"MFI\",      \"magenta\", 3, \"MFI\"),\n                \n                # Painel 4: RSI (refer\u00eancia)\n                (\"rsi\",      \"RSI\",      \"white\",   4, \"RSI\"),\n            )\n        )\n\n    def fitness(self, states, raw_states, asset, currency):\n        \"\"\"\n        M\u00e9tricas de otimiza\u00e7\u00e3o focadas em precis\u00e3o de revers\u00f5es.\n        \"\"\"\n        return [\n            \"roi_currency\",\n            \"roi\", \n            \"cagr\",\n            \"sortino\",\n            \"maximum_drawdown\",\n            \"trade_win_rate\",\n            \"profit_factor\",\n        ], {}\n\n\n# ===========================================================================\n# CONFIGURA\u00c7\u00c3O GLOBAL\n# ===========================================================================\n\n# Timeframe: 300 = 5 minutos (ideal para detec\u00e7\u00e3o de revers\u00f5es intraday)\nTIMEFRAME = 300\n\n# Taxa de corretagem\nFEE = 0.1\n\n\n# ===========================================================================\n# FUN\u00c7\u00c3O MAIN\n# ===========================================================================\ndef main():\n    \"\"\"\n    Configura e executa a estrat\u00e9gia ReversalHunter.\n    \"\"\"\n    asset, currency = \"BTC\", \"USDT\"\n    wallet = qx.PaperWallet({asset: 0, currency: 10000}, fee=FEE)\n    \n    data = qx.Data(\n        exchange=\"binance\",\n        asset=asset,\n        currency=currency,\n        begin=\"2026-01-01\",\n        end=int(time.time()),\n        candle_size=TIMEFRAME,\n    )\n    # python strategies/ReversalHunter.py\n    bot = ReversalHunter()\n    qx.dispatch(bot, data, wallet)\n\n\nif __name__ == \"__main__\":\n    main()\n",
 "BEST ROI TUNE_Mon Jan 26 10:23:53 2026_BTC_USDT_300_Mon Jan 26 10:23:53 2026": {
  "identifier": "BEST ROI TUNE_Mon Jan 26 10:23:53 2026_BTC_USDT_300_Mon Jan 26 10:23:53 2026",
  "begin_date": "01/01/2026",
  "end_date": "26/01/2026",
  "duration": "25 Dias",
  "asset": "BTC",
  "currency": "USDT",
  "timeframe": 300,
  "tune": {
   "stochrsi_period": 8,
   "stochrsi_k_period": 14,
   "stochrsi_k_slow": 4,
   "stochrsi_d_period": 3,
   "adx_period": 7,
   "mfi_period": 28,
   "stochrsi_oversold": 12,
   "stochrsi_overbought": 79,
   "mfi_oversold": 39,
   "mfi_overbought": 60,
   "adx_threshold": 15,
   "di_diff_min": 7,
   "require_adx_rising": 1
  },
  "results": {
   "roi": 1.082999126784018,
   "roi_currency": 1.082999126784018,
   "cagr": 2.1986863123624443,
   "maximum_drawdown": 0.03841143793776873,
   "profit_factor": 1.082999126784018,
   "trade_win_rate": 1.0
  }
 }
}