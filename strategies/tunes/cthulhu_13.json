{
 "source": "\"\"\"\n\u2554\u2550\u2557\u2554\u2566\u2557\u2566\u2550\u2557\u2554\u2550\u2557\u2554\u2566\u2557\u2554\u2550\u2557\u2550\u2557 \u2566\n\u2551\u2550\u256c\u2557\u2551 \u2560\u2566\u255d\u2560\u2550\u2563 \u2551\u2551\u2551\u2563 \u2554\u2569\u2566\u255d\n\u255a\u2550\u255d\u255a\u2569 \u2569\u255a\u2550\u2569 \u2569\u2550\u2569\u255d\u255a\u2550\u255d\u2569 \u255a\u2550\n\ncthulhu.py\n\nCthulhu Bollinger Bands\n\nEstrat\u00e9gia de Bollinger Bands com Parabolic SAR.\n\nINDICADORES:\n1. EMA: M\u00e9dia m\u00f3vel exponencial para tend\u00eancia\n2. Standard Deviation: Volatilidade para bandas\n3. Bollinger Bands: Canal superior e inferior\n4. Parabolic SAR: Detec\u00e7\u00e3o de revers\u00e3o de tend\u00eancia\n\nL\u00d3GICA:\n- Channel Trading: Opera dentro das bandas\n- Trend Following: Opera na dire\u00e7\u00e3o da tend\u00eancia\n- SAR Reversal: Detecta revers\u00f5es de tend\u00eancia\n- Breakout: Captura rompimentos\n\"\"\"\n\nimport qtradex as qx\nimport numpy as np\n\n\nclass Cthulhu(qx.BaseBot):\n    \"\"\"\n    Estrat\u00e9gia Cthulhu Bollinger Bands.\n    \n    Combina Bollinger Bands, EMA e Parabolic SAR para identificar\n    oportunidades de channel trading e trend following.\n    \"\"\"\n    \n    def __init__(self):\n        \"\"\"Inicializa\u00e7\u00e3o da estrat\u00e9gia.\"\"\"\n        self.timeframe = TIMEFRAME\n        self.fee = FEE\n        self.warmup = 100\n        \n        # ===================================================================\n        # TUNE: Valores padr\u00e3o calibrados\n        # Ponto de partida para otimiza\u00e7\u00e3o\n        # ===================================================================\n        self.tune = {\n            # Bollinger Bands\n            \"ema_period\": 20,              # Per\u00edodo da EMA central\n            \"std_period\": 20,              # Per\u00edodo do desvio padr\u00e3o\n            \"upper_deviations\": 2.0,       # Desvios para banda superior\n            \"lower_deviations\": 2.0,       # Desvios para banda inferior\n            \n            # Fatores de trading (sensibilidade dos sinais)\n            \"channel_buy_factor\": 1.0,     # Fator de compra em canal\n            \"channel_sell_factor\": 1.0,    # Fator de venda em canal\n            \"trend_buy_factor\": 1.0,       # Fator de compra em tend\u00eancia\n            \"trend_sell_factor\": 1.0,      # Fator de venda em tend\u00eancia\n            \"breakout_buy_factor\": 1.0,    # Fator de compra em rompimento\n            \"breakout_sell_factor\": 1.0,   # Fator de venda em rompimento\n            \n            # Parabolic SAR\n            \"sar_accel\": 0.02,             # Acelera\u00e7\u00e3o SAR\n            \"sar_max\": 0.2,                # M\u00e1ximo SAR\n            \n            # Canal threshold\n            \"channel\": 0.01,               # Largura m\u00ednima do canal\n        }\n        \n        # ===================================================================\n        # CLAMPS: Cobertura AMPLA para Cripto Vol\u00e1til\n        # ===================================================================\n        self.clamps = {\n            # Bollinger Bands (ranges amplos para volatilidade)\n            \"ema_period\": [10, 20, 50, 5],           # 10-50: scalp a swing\n            \"std_period\": [10, 20, 50, 5],           # 10-50: sincronizado com EMA\n            \"upper_deviations\": [1.5, 2.0, 3.0, 0.25], # 1.5-3.0: bandas estreitas a largas\n            \"lower_deviations\": [1.5, 2.0, 3.0, 0.25], # 1.5-3.0: bandas estreitas a largas\n            \n            # Fatores de sensibilidade (step menor para granularidade)\n            \"channel_buy_factor\": [0.9, 1.0, 1.2, 0.05],\n            \"channel_sell_factor\": [0.8, 1.0, 1.1, 0.05],\n            \"trend_buy_factor\": [0.9, 1.0, 1.2, 0.05],\n            \"trend_sell_factor\": [0.8, 1.0, 1.1, 0.05],\n            \"breakout_buy_factor\": [0.95, 1.0, 1.1, 0.05],\n            \"breakout_sell_factor\": [0.9, 1.0, 1.05, 0.05],\n            \n            # Parabolic SAR (ranges padr\u00e3o)\n            \"sar_accel\": [0.01, 0.02, 0.05, 0.01],\n            \"sar_max\": [0.1, 0.2, 0.3, 0.05],\n            \n            # Canal threshold\n            \"channel\": [0.005, 0.01, 0.03, 0.005],\n        }\n\n    def indicators(self, data):\n        \"\"\"Calcula indicadores t\u00e9cnicos.\"\"\"\n        close = data[\"close\"]\n        high = data[\"high\"]\n        low = data[\"low\"]\n        \n        # EMA central (Bollinger middle)\n        ma0 = qx.ti.ema(close, int(self.tune[\"ema_period\"]))\n        ma1 = ma0[:-1]\n        \n        # Desvio padr\u00e3o para bandas\n        std = qx.ti.stddev(close, int(self.tune[\"std_period\"]))\n        \n        # Sincronizar arrays\n        ma0, ma1, std = qx.truncate(ma0, ma1, std)\n        \n        # Bandas de Bollinger\n        upper = ma0 + self.tune[\"upper_deviations\"] * std\n        lower = ma0 - self.tune[\"lower_deviations\"] * std\n        \n        # Largura do canal\n        diff = upper - lower\n        \n        # Parabolic SAR\n        sar0 = qx.ti.psar(high, low, self.tune[\"sar_accel\"], self.tune[\"sar_max\"])\n        sar1 = sar0[:-1]\n        \n        # Sincronizar SAR\n        sar0, sar1 = qx.truncate(sar0, sar1)\n        \n        return {\n            \"ma0\": ma0,\n            \"ma1\": ma1,\n            \"std\": std,\n            \"upper\": upper,\n            \"lower\": lower,\n            \"diff\": diff,\n            \"sar0\": sar0,\n            \"sar1\": sar1,\n        }\n\n    def strategy(self, tick_info, indicators):\n        \"\"\"\n        L\u00f3gica de decis\u00e3o.\n        \n        1. Channel Trading: Compra na banda inferior, vende na superior\n        2. Trend Following: Segue a dire\u00e7\u00e3o da tend\u00eancia\n        3. SAR Reversal: Detecta revers\u00f5es\n        4. Breakout: Captura rompimentos\n        \"\"\"\n        ma0 = indicators[\"ma0\"]\n        ma1 = indicators[\"ma1\"]\n        upper = indicators[\"upper\"]\n        lower = indicators[\"lower\"]\n        price = tick_info[\"close\"]\n        diff = indicators[\"diff\"]\n        sar0 = indicators[\"sar0\"]\n        sar1 = indicators[\"sar1\"]\n\n        channel_buy_factor = self.tune[\"channel_buy_factor\"]\n        channel_sell_factor = self.tune[\"channel_sell_factor\"]\n        trend_buy_factor = self.tune[\"trend_buy_factor\"]\n        trend_sell_factor = self.tune[\"trend_sell_factor\"]\n        breakout_buy_factor = self.tune[\"breakout_buy_factor\"]\n        breakout_sell_factor = self.tune[\"breakout_sell_factor\"]\n        channel = self.tune[\"channel\"]\n\n        # CHANNEL TRADING (mercado lateral)\n        if diff < channel:\n            if channel_buy_factor * price < lower:\n                return qx.Buy()\n            elif channel_sell_factor * price > upper:\n                return qx.Sell()\n        # TREND TRADING (mercado direcional)\n        else:\n            if trend_buy_factor * price > ma0:\n                return qx.Buy()\n            elif trend_sell_factor * price < ma0:\n                return qx.Sell()\n\n        # SAR REVERSAL (revers\u00e3o de tend\u00eancia)\n        if sar0 < ma0 and sar1 > ma1:\n            return qx.Buy()\n        if sar0 > ma0 and sar1 < ma1:\n            return qx.Sell()\n\n        # BREAKOUT (rompimento)\n        if breakout_buy_factor * price > ma0:\n            return qx.Buy()\n        elif breakout_sell_factor * price < ma0:\n            return qx.Sell()\n        \n        return None\n\n    def plot(self, *args):\n        \"\"\"Define a visualiza\u00e7\u00e3o no gr\u00e1fico.\"\"\"\n        qx.plot(\n            self.info,\n            *args,\n            (\n                (\"upper\", \"Upper Band\", \"white\", 0, \"Cthulhu\"),\n                (\"lower\", \"Lower Band\", \"white\", 0, \"Cthulhu\"),\n                (\"ma0\", \"Middle Band\", \"cyan\", 0, \"Cthulhu\"),\n                (\"sar0\", \"Parabolic SAR\", \"yellow\", 0, \"Cthulhu\"),\n            ),\n        )\n\n    def fitness(self, states, raw_states, asset, currency):\n        \"\"\"M\u00e9tricas de otimiza\u00e7\u00e3o.\"\"\"\n        return [\n            \"roi_currency\",\n            \"roi\",\n            \"cagr\",\n            \"sortino\",\n            \"maximum_drawdown\",\n            \"trade_win_rate\",\n        ], {}\n\n\n# ===========================================================================\n# CONFIGURA\u00c7\u00c3O GLOBAL\n# ===========================================================================\n# 60=1m, 300=5m, 900=15m, 3600=1h, 14400=4h, 86400=1d\nTIMEFRAME = 300  # 5min\nFEE = 0.1  # 0.1%\n\n\n# ===========================================================================\n# MAIN\n# ===========================================================================\ndef main():\n    \"\"\"Configura e executa a estrat\u00e9gia.\"\"\"\n    import time\n    asset, currency = \"SOL\", \"USDT\"\n    wallet = qx.PaperWallet({asset: 0, currency: 10000}, fee=FEE)\n    \n    data = qx.Data(\n        exchange=\"binance\",\n        asset=asset,\n        currency=currency,\n        begin=\"2025-11-01\",\n        end=int(time.time()),\n        candle_size=TIMEFRAME, \n    )\n    \n    # python strategies/cthulhu.py\n    bot = Cthulhu()\n    qx.dispatch(bot, data, wallet)\n\n\nif __name__ == \"__main__\":\n    main()",
 "BEST ROI TUNE_Sat Jan 24 14:04:06 2026_SOL_USDT_300_Sat Jan 24 14:04:06 2026": {
  "identifier": "BEST ROI TUNE_Sat Jan 24 14:04:06 2026_SOL_USDT_300_Sat Jan 24 14:04:06 2026",
  "begin_date": "01/11/2025",
  "end_date": "24/01/2026",
  "duration": "2 Meses e 24 Dias",
  "asset": "SOL",
  "currency": "USDT",
  "timeframe": 300,
  "tune": {
   "ema_period": 10,
   "std_period": 50,
   "upper_deviations": 1.5,
   "lower_deviations": 2.25,
   "channel_buy_factor": 1.125056982759199,
   "channel_sell_factor": 1.1,
   "trend_buy_factor": 1.2,
   "trend_sell_factor": 0.8,
   "breakout_buy_factor": 1.0896386408743224,
   "breakout_sell_factor": 1.05,
   "sar_accel": 0.03,
   "sar_max": 0.3,
   "channel": 0.02002580230109597
  },
  "results": {
   "roi": 1.1642881457300605,
   "roi_currency": 1.1642881457300605,
   "cagr": 3.418929371630723,
   "maximum_drawdown": 0.08342985474328836,
   "trade_win_rate": 0.7073170731707317
  }
 }
}